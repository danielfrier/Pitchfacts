<!doctype HTML>
<html>
	<head>
			<!--D3-->
			<script src="https://d3js.org/d3.v4.min.js"></script>
			<!--CSS file-->
			<link rel="stylesheet" type="text/css" href="styles.css">
			<!-- Font -->
			<link href="https://fonts.googleapis.com/css?family=PT+Serif" rel="stylesheet">
			<!-- JQuery -->
			<script src='https://code.jquery.com/jquery-3.3.1.min.js'></script>

			<link href="https://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

			<link rel="shortcut icon" type="image/png" href="images/icon.png" />
			<title>PitchFacts</title>
	</head>
	<body>
		<div class="main-header">
			<img src="images/pitchfork3.png" />
			<div class="names">
				<a>The Latest</a>
				<a style="color: white;">Reviews</a>
				<a>Best New Music</a>
				<a>Features</a>
				<a>Artists</a>
				<a>Video</a>
			</div>
		</div>
		<div class="record-header">
			<div class="record-info">
				<h1 class="artist">
					Albert Caldarelli, Daniel Frier, <br />
					Eliot Huang & Eric Porter
				</h1>
				<h1 class="title">
					Pitchfacts
				</h1>
			</div>
			<div class="record-score">
				<div class="record">
					<img src="images/record.jpg" />
					<figcaption>INFO 4310, Spring 2018</figcaption>
				</div>
				<img class="score" src="images/score.png" />
			</div>
		</div>
		<div class="body">
			<div class="point">
				<h3>Project Rationale</h3>
				<p>
					Today we live in an age where information is at the tips of our fingers. Data about everything resides everywhere, with even more being generated by users every day. As consumers, we've also become more keen to using data and reviews to make decisions, whether that be checking Rotten Tomatoes to gauge whether you should watch that new move that just came out, or searching for more "undiscovered" bands by filtering their follower counts. In the music industry especially, the Internet has given rise to data-driven streaming services which have completely reshaped how people consume and share music. Music criticism has also seen a resurgence online, with popular independent reviewers like Anthony Fantano expanding their cultural prevalence to compete with more traditional and established music reviewers.
				</p>
				<p>
					It is within this information age where we grew curious to examine the reviews of Pitchfork. Pitchfork is one of the most prominent and well-known music review websites, especially in the more independent and underground scenes. Beginning in 1995, the online music magazine has reached an Alexa rank of 361 in the United States and even operates its own Pitchfork Music Festival in Chicago every year starting 2006. One of the most interesting things about Pitchfork is the real-world impact of its reviews on the rise and fall various music artists. For example, there have been many documented articles that credit the rise of now popular artists like Bon Iver, Sufjan Stevens, and Arcade Fire solely to a positive Pitchfork Review, including an article in the Washington Post titled <a href="http://www.washingtonpost.com/wp-dyn/content/article/2006/04/28/AR2006042800457.html">Giving Indie Acts A Plug, or Pulling It</a> which explains how after Pitchfork's gave then-unknown Arcade Fire's <span class="italics">Funeral</span> a score of 9.7, sales for the record exploded and the band reached mainstream success. Pitchfork reviews are also sometimes known for their quirkiness, including their infamous review of Jet's <span class="italics">Shine On</span>, <a href="https://pitchfork.com/reviews/albums/9464-shine-on/">where they gave the album a 0.0 and the review entirely consisted of a Youtube video of a monkey peeing on itself.</a> Pitchfork's eccentricity as a reviewer made us question and want to analyze how the organization's actual reviews had established its amount of musical credibility in the industry.
				</p>
				<p>
					<strong>Through this project, we hope to show you how one can use textual and lexical analysis to find interesting things in the today's ever-growing data landscape. </strong> In our case as music fans, we will be showing off various analytical techniques like Topic Modeling, Latent Semantic Analysis (LSA), and Word Embedding Models (WEMs) within the context of Pitchfork reviews. We hope that you find this as an interesting introduction to finding insight in text through these algorithms.
				</p>
			</div>

			<div class="point">
				<h3>LSA Scatterplot</h3>
				<p>
					Using a technique called Latent Semantic Analysis (LSA for short) it's possible to represent a whole corpus of texts, and their words, using only two dimensions. Text is a highly multidimensional type of data, our dataset of reviews is [19,555x50,000], so plotting it would be impossible! LSA reduces this to lower dimensional space by finding the dimensions, or "topics" that can represent the most "distinctiveness" possible in just two dimensions.
				</p>
				<p>
					Read more about Latent Semantic Analysis <a href="https://en.wikipedia.org/wiki/Latent_semantic_analysis">here</a> and <a href="http://lsa.colorado.edu/papers/JASIS.lsi.90.pdf">here!</a>
				</p>
				<p>
					If you notice in our graph below that it seems to be a split down the middle between "rock" and "rap" this is because the LSA algorithm has calculated these to be the most representative and distinct topic groupings. Interestingly, looking further, it appears that all of the other genres are very similar to rock and appear in the upper half of the graph, whereas only rap and scattered songs of other genres are in the bottom. Further down, we discuss the calculated similarities between genres, and rap has a mean similarity of 40% to the other genres (most have a mean similarity around 55%-60%), and is the only genre with a negative similarity-distance score, meaning that it is by far the most distinct of all genres.
				</p>
			</div>
			<div class="viz" id="viz2"></div>

			<div class="point">
				<h3>Force-Directed Graph of Genres</h3>
				<p>
					Every word in a text can be represented by a "word embedding model". These models represent the context a word appears in, so the word embedding model (WEM for short) of the word "king" might have things like 'throne','crown','palace','castle','powerful', whereas the WEM for "mouse" might have 'cheese','hole','trap','ears'. WEMs are very powerful at certain tasks such as linguistic analogy, determining which object doesn't match a group, and determining similarity between words.
				</p>
				<p>
					Read more about WEMs <a href="https://radimrehurek.com/gensim/models/word2vec.html">here!</a>
				</p>
				<p>
					In the below graph we have represented the common musical genres as nodes and they are linked by their WEM similarity. This has similar genres appearing close together, and distant ones far apart. Clicking on any genre node will bring up the sub graph of its subgenres, directed by their WEM similarity.
				</p>
			</div>
			<div class="viz" id="viz3"></div>

			<div class="point">
				<h3>Could you write for Pitchfork?</h3>
				<p>
					Over the years Pitchfork has seen countless different staff writers and editors writing music reviews and news for the latest music. Although each different writer has their own unique voice, they all loosely share the same tone of musical authority that is needed in Pitchfork criticism.
				</p>
				<p>
					Below, we've made a tool that can test whether what you've written or not is lexically or tonally similar to Pitchfork writers. Enter what you want into the text field and click submit to see how similar your review style is to a real Pitchfork review!
				</p>
			</div>

			<div class="viz" id="viz1">
				<div class="could-write-container">
					<div class="could-write-textarea">
						<textarea id="userreviewCheck" class="review_textarea"></textarea>
					</div>
					<div class="could-write-resultcontainer">
						<button onclick="checkReview();" class="review_submit">Check!</button>
						<center class="hidden" id="reviewLoading"><i class="fa fa-spinner fa-spin fa-fw fa-2x"></i></center>
						<div class="grade_container hidden" id="grade_container">
							<p id="grade_letter"></p>
							<p id="grade_percent"></p>
						</div>
					</div>
				</div>
			</div>
			<div class="point">
			<p>
				If you got less than a "C" and are usually so used to stellar grades, don't feel bad! Our similarity algorithm relies on a 36-dimension topic model of the reviews, and a poor score just means that you didn't write about any of the topics that Pitchfork does (although this probably means you weren't even writing about music!). In fact, by this measure, almost 10% of all Pitchfork reviews are 'D' reviews, and this is usually due to rambling or novice writing.
			</p>
		</div>
			<div id="vis4">

			</div>
		</div>


		<!-- Jquery needed for AJAX -->
		<script
		src="https://code.jquery.com/jquery-3.3.1.js"
		integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
		crossorigin="anonymous"></script>
		<script>
		//LINE GRAPH DATA
			var setOfGenres = []; //set of genres
			var setOfYears= []; //set of years

			var reviewsOverYears = {}; //dictionary of year -> total reviews that year
			var genresOverYears = {}; //dictionary of genre -> total genre reviews over years
			var genresPercentagesOverYears = {} //dictionary of genre -> total percentage out of all reviews that year over time

			//Save raw review data
			var pitchforkReviews;

			function getReviewFromId(id){
				return pitchforkReviews[parseInt(id)];
			}

				orig_paths =[]
				norm_paths =[]
				orig_ds = []
				normal_genre=false;
			xLineScale = d3.scaleTime()
   			 .domain([new Date(1999, 0, 0), new Date(2018, 0, 0)]).range([35,935]);
			yLineScale = d3.scaleLinear().domain([0,1]).range([840,5]);
			d3.csv("data/p4kreviews.csv", function(d){
				var data = d;

				//Eric
				info = d;
				time_dates={};

				info.forEach(function(obj){
					// if the data exists
					year = obj.date.split(" ")[2];
					// console.log(obj.date.split(" "));
					if(!time_dates.hasOwnProperty(year)){
						time_dates[year]= [];
						time_dates[year].push(obj);
					}else if(obj.date.split(" ")[2] == year){
						time_dates[year].push(obj)
					}


				});
				genre_perc_per_year = {};
				genre_val_maxes = {}
				genre_maxes_percentages = {}
				for(var year in time_dates){
					genre_perc_per_year[year] = {}; //creates a object of all the genres per year
					genre_maxes_percentages[year] = genre_maxes_percentages[year] || [];
					for(var i=0; i< time_dates[year].length;i++){// list of all the objects in one year
						genre = time_dates[year][i].genre; // create genre ... rap ,rock etc
						genre_val_maxes[genre] = genre_val_maxes[genre] || 0;
						if(!genre_perc_per_year[year].hasOwnProperty(genre)){ // does our object not have the genre  attribute in it
						// for the first genre find the percentage  and add it into the list
							genre_perc_per_year[year][genre]= time_dates[year].filter(record => record.genre == genre).length/time_dates[year].length;
							genre_val_maxes[genre]= time_dates[year].filter(record => record.genre == genre).length>genre_val_maxes[genre]?time_dates[year].filter(record => record.genre == genre).length:genre_val_maxes[genre]; // create it and make it a list containing genre and percentage of genre that year
								// console.log(genre_perc_per_year);

						}else{
							// console.log("I've seen this genre before");
						}
					}
				}
				for(year in time_dates){
					for(var i=0; i< time_dates[year].length;i++){
						genre = time_dates[year][i].genre; // create genre ... rap ,rock etc
						genre_maxes_percentages[year][genre] = genre_maxes_percentages[year][genre]||0;
						if(genre_perc_per_year[year].hasOwnProperty(genre)){
							genre_maxes_percentages[year][genre]= time_dates[year].filter(record => record.genre == genre).length/genre_val_maxes[genre];
						}
					}

				}
					// console.log(genre_perc_per_year);
					time_and_percentages={};
					time_and_percentages_maxes = {}
					genre_colors={};
					for( var year in genre_perc_per_year){
						for(var genre in genre_perc_per_year[year]){
							if(time_and_percentages[genre]==undefined){
							time_and_percentages[genre] =[];
							time_and_percentages_maxes[genre] =[];
						}
							time_and_percentages[genre].push({x:new Date(parseInt(year),0,0),y:genre_perc_per_year[year][genre]});
							time_and_percentages_maxes[genre].push({x:new Date(parseInt(year),0,0),y:genre_maxes_percentages[year][genre]});
						}
					}

				//final clean data (2:28am)

				var last_vis = d3.select("#vis4");
				// svg dimensions
				final_svg= last_vis.append("svg").attr('id',"last_svg" );
				final_svg.attr('width',1040)
				.attr('height',960);
				var normG = final_svg.append('g')
				var normRect = normG.append('rect').attr('x',width/4).attr('y',30).attr('rx',5).attr('ry',5).style('stroke','black').style('stroke-width',2).style('fill','#EEE').attr('width',150).attr('height',20).attr('onclick','norm_genre()').attr('onmouseenter',"setCursor('pointer')").attr('onmouseleave',"setCursor('default')")
				var normText = normG.append('text').attr('x',width/4+2).attr('y',43).attr('id','normTextButton').text('Normalize Data by Max').attr('onclick','norm_genre()').attr('onmouseenter',"setCursor('pointer')").attr('onmouseleave',"setCursor('default')").attr('font-size',14)

				var pathmaker = d3.line().x(function(d) {return xLineScale(d.x)}).y(function(d){return yLineScale(d.y)});
				finalColors = {};
				for(var genre in time_and_percentages){
					orig_paths.push(final_svg.append("path").data([time_and_percentages[genre]]).attr('class', 'lines').attr('genre',genre.slice(0,3)).attr('id','linegraph'+genre.slice(0,3)).attr('d',pathmaker).style('stroke', genreColorMapping[genre]).style('stroke-width',2));
					norm_paths.push(final_svg.append("path").data([time_and_percentages_maxes[genre]]).attr('class', 'lines').attr('d',pathmaker).style('stroke', genreColorMapping[genre]).attr('opacity',0));
					finalColors[genre]=genreColorMapping[genre];
				}
				orig_paths.forEach(function(d){
					orig_ds.push(d.attr('d'))
				})

					final_svg.append("g")
				  .attr("transform", "translate(0," + 840 + ")")
				  .call(d3.axisBottom(xLineScale));
				final_svg.append("g")
				  .attr("transform", "translate(35," + 0 + ")")
				  .call(d3.axisLeft(yLineScale));

				  color_list = Object.values(genreColorMapping);
				  for(var i=0;i<10;i++){
				  final_svg.append('text').attr('x', 950)
				  .attr('y', 20+(i*20)).style('stroke',Object.values(finalColors)[i]).text(Object.keys(finalColors)[i]);
				  }
				  // final_svg.append('text').attr('x',950 ).attr('y', 250).text("X axis Percentages");
				  // final_svg.append('text').attr('x',950 ).attr('y', 280).text("Y axis Time");

				  final_svg.append('text').attr('x',445 ).attr('y', 15).text("Percentages Of Genres over Time");
				//


				pitchforkReviews = d;
				console.log(d);

				//make setOfGenres and setOfYears
				for (var i=0;i<data.length;i++) {
					var genre = data[i]["genre"];
					var year = data[i]["date"].split(" ")[2];
					if (!(setOfGenres.includes(genre))) { setOfGenres.push(genre); }
					if (!(setOfYears.includes(year))) { setOfYears.push(year); }
				}
				//make genresOverYears
				for (var i=0; i<setOfGenres.length; i++) {
					var genre = setOfGenres[i]
					var genre_dict = {} //year -> number of reviews
					for (var j=0;j<data.length;j++) {
						if (genre == data[j]["genre"]) {
							var year = data[j]["date"].split(" ")[2];
							if (!(year in genre_dict)) { genre_dict[year] = 1 }
							else { genre_dict[year] = genre_dict[year] + 1 }
						}
					}
					genresOverYears[genre] = genre_dict;
				}
				//make reviewsOverYears
				for (var i=0; i<setOfYears.length; i++) {
					var year = setOfYears[i];
					var yearly_total = 0;
					for (var j=0;j<setOfGenres.length;j++) {
						var genre = setOfGenres[j];
						yearly_total = yearly_total + genresOverYears[genre][year];
					}
					reviewsOverYears[year] = yearly_total
				}
				//make genresPercentagesOverYears
				for (var i=0; i<setOfGenres.length; i++) {
					var genre = setOfGenres[i];
					var genre_percentages = {};
					for (var j=0;j<setOfYears.length;j++) {
						var year = setOfYears[j];
						var total_reviews = reviewsOverYears[year];
						var genre_reviews = genresOverYears[genre][year];
						var genre_percent = genre_reviews / total_reviews;
						genre_percentages[year] = genre_percent
					}
					genresPercentagesOverYears[genre] = genre_percentages;
				}
			});

				function norm_genre(){
					normal_genre = !normal_genre;
					d3.select('#normTextButton').text(normal_genre?"Show Original Data":"Normalize Data by Max")
					orig_paths.forEach(function(d,i){
						d3.select('#linegraph'+orig_paths[i].attr('genre')).transition().duration(200)
				        .attr("d",normal_genre?norm_paths[i].attr('d'):orig_ds[i]);
					})
				}
			function checkReview(){
				var input = $("#userreviewCheck").val();

				//Running on my web server so it stays up forever
				$("#reviewLoading").removeClass("hidden");

				var apiUrl = "https://churchdeposit.com:5000";
				$.post(apiUrl+"/userreview",{input:input},function(data){
					console.log(data);
					$("#reviewLoading").addClass("hidden");
					if (data.success){
						var grade = data.success.grade;
						$("#grade_container").removeClass("hidden");

						$("#grade_container").attr("class","grade_container grade_"+grade);
						$("#grade_letter").html(grade.toUpperCase());
						$("#grade_percent").html((data.success.probability)+"% probability");
					}
				},"json");
			}
			function truncateString(str,limit){
				limit = limit||0;
				if (limit>0){max = limit;}
				if (str === null || typeof str === "undefined"){
					str = "";
				}
				var truncate = (str.length > max);

				return truncate ? str.substr(0, max-1) + '...' : str;
			}
		</script>

	</script>

	<!-- LSA SCATTER PLOT  -->

	<style>
		.axis path,
		.axis line {
			fill: none;
			stroke: #000;
			shape-rendering: crispEdges;
		}
		.dot {
			stroke: #000;
		}
	</style>
	<script>


//SET CURSOR APPEARENCE
function setCursor(x) {document.body.style.cursor = x;}
		genreColorMapping = {'rock':'#1f77b4','Rock':'#1f77b4',
						'Folk/Country':'#2ca02c','country':'#2ca02c','Country':'#2ca02c',
						'electronic':'#ff7f0e','Electronic':'#ff7f0e',
						'None':'#7f7f7f','Global':'#7f7f7f','global':'#7f7f7f',
						'Pop/R&B':'#152b4f','pop':'#152b4f','Pop':'#152b4f',
						'metal':'#17becf','Metal':'#17becf',
						'rap':'#d62728','Rap':'#d62728',
						'Experimental':'#9467bd','experimental':'#9467bd',
						'jazz':'#8c564b','Jazz':'#8c564b',
						'folk':'#e377c2','Folk':'#e377c2',
						'r&b':'#bcbd22','R&B':'#bcbd22', 'randb':'#bcbd22'}

		var margin = {top: 20, right: 20, bottom: 30, left: 40},
				width = 960 - margin.left - margin.right,
				height = 500 - margin.top - margin.bottom;

		var svg2 = d3.select("#viz2").append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
			.append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");
		svg2.append('text').text('Click on genres to filter').attr('font-weight','bold').attr('font-size',15).attr('x',width-260).attr('y',5)
		var svg2Overlays;
		var curHoveredReview = false;
				var clearG = svg2.append('g')
				var clearRect = clearG.append('rect').attr('x',width-119).attr('y',184).attr('rx',5).attr('ry',5).style('stroke','black').style('stroke-width',2).style('fill','#EEE').attr('width',120).attr('height',20).attr('onclick','filterScatter()').attr('onmouseenter',"setCursor('pointer')").attr('onmouseleave',"setCursor('default')")
				var clearText = clearG.append('text').attr('x',width-108).attr('y',199).text('Clear Selections').attr('onclick','filterScatter()').attr('onmouseenter',"setCursor('pointer')").attr('onmouseleave',"setCursor('default')").attr('font-size',14)

		function getStarString(score){
			score = parseFloat(score);

			scoreInteger = Math.floor(score);
			scoreUseHalf = ((score-scoreInteger) > .5);
			console.log(score,scoreInteger,scoreUseHalf);
			var retstr = "<p class='inline'>";
			for (var i=0; i<scoreInteger; i++){
				retstr = retstr + "<i class='fa fa-star inline'></i>";
			}
			if (scoreUseHalf){
				retstr = retstr + "<i class='fa fa-star-half inline'></i>";
			}
			retstr = retstr+"</p>";

			return retstr;
		}

		function hoveredReview(review,xScale,yScale){
			if (curHoveredReview){
				curHoveredReview.remove();
				curHoveredReview = false;
			}
			var review_raw = getReviewFromId(review.doc_id);

			curHoveredReview = svg2Overlays.append("g").attr("transform","translate("+xScale(review.x)+","+yScale(review.y)+")");
			curHoveredReview.append("rect")
				.attr("class","overlay-container")
				.attr("width",150)
				.attr("height",100);
			curHoveredReview.append("text")
				.attr("class","overlay-artist")
				.attr("x",60)
				.attr("y",12)
				.text(review_raw.artist);
			curHoveredReview.append("text")
				.attr("class","overlay-album")
				.attr("x",60)
				.attr("y",28)
				.text(review_raw.album);
			curHoveredReview.append("svg:foreignObject")
				.attr("class","inline")
				.attr("x",0)
				.attr("y",52)
				.html(getStarString(review_raw.score));
		}

		d3.csv("models/lsa_coords.csv", function(d){
			var data = d;

			var xData = [];
			var yData = [];
			var genreData = [];
			for (var i = 0; i < data.length; i++) {
				xData.push(parseFloat(data[i]["x"]));
				yData.push(parseFloat(data[i]["y"]));
				genreData.push(data[i]["genre"]);
			};

			var xMin = d3.extent(xData)[0];
			var xMax = d3.extent(xData)[1];
			var yMin = d3.extent(yData)[0];
			var yMax = d3.extent(yData)[1];

			var xScale = d3.scaleLinear()
					.domain([xMin-1, xMax+3])
					.range([0, width]);
			var yScale = d3.scaleLinear()
					.domain([yMin-0.5, yMax+0.5])
					.range([height, 0]);

			// var xAxis = d3.axes()
			// 		.scale(xScale)
			// 		.orient("bottom");
			// var yAxis = d3.axes()
			// 		.scale(yScale)
			// 		.orient("left");

			// svg2.append("g")
			// 		.attr("class", "x axis")
			// 		.attr("transform", "translate(0," + height + ")")
			// 		.call(d3.axisBottom(xScale))
			// 	.append("text")
			// 		.attr("class", "label")
			// 		.attr("x", width)
			// 		.attr("y", -6)
			// 		.style("text-anchor", "end")
			// 		.text("LSA Dimension 1");

			// svg2.append("g")
			// 		.attr("class", "y axis")
			// 		.call(d3.axisLeft(yScale))
			// 	.append("text")
			// 		.attr("class", "label")
			// 		.attr("transform", "rotate(-90)")
			// 		.attr("y", 6)
			// 		.attr("dy", ".71em")
			// 		.style("text-anchor", "end")
			// 		.text("LSA Dimension 2")

			svg2.selectAll(".dot")
					.data(data)
				.enter().append("circle")
					.attr('class',function(d){return ('dot '+ d.genre.slice(0, 3))})
					.attr('id',function(d){return d.doc_id})
					.attr("r", 3.5)
					.attr("cx", function(d) { return xScale(d.x); })
					.attr("cy", function(d) { return yScale(d.y); })
					.style("fill", function(d) { return genreColorMapping[d.genre]; });
					// .on("mouseover",function(d){
					// 	hoveredReview(d,xScale,yScale);
					// 	console.log(d);
					// });


					var legend = svg2.selectAll(".legend")
					.data(['Rock','Country','Electronic', 'Experimental', 'None', 'Global', 'Metal' ,'Rap' ,'Jazz' ])
					.enter().append("g")
						.attr("class", "legend")
						.attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });
				legend.append("rect")
						.attr("x", width - 18)
						.attr("width", 18)
						.attr("height", 18)
						.attr("onclick", function(d){return "filterScatter('"+d+"')"})
						.attr('onmouseenter',"setCursor('pointer')").attr('onmouseleave',"setCursor('default')")
						.text(function(d) { return d; })
						.style("fill", function(d){
							var tempgen = d;
							if(tempgen=='Folk'){tempgen='Country'}
							if(tempgen=='R&B'){tempgen='Pop/R&B'}
							if(tempgen=='Pop'){tempgen='Pop/R&B'}
							return genreColorMapping[tempgen]});

				legend.append("text")
						.attr("x", width - 24)
						.attr("y", 9)
						.attr("dy", ".35em")
						.attr('onmouseenter',"setCursor('pointer')").attr('onmouseleave',"setCursor('default')")
						.attr("onclick", function(d){return "filterScatter('"+d+"')"})
						.style("text-anchor", "end")
						.text(function(d) { return d; });

				//must be drawn last
				svg2Overlays = svg2.append("g").attr("class","overlay");
			});





			selected_genres = []
			function filterScatter(x) {
				selected_genre = x || '';
				if(selected_genre==''){
					selected_genres=[]
				}
				else{
				var selected_genre = x
					//slice first 3 because has trouble with & and / characters
				if(selected_genre=='Folk'){
					selected_genre = 'Folk/Country'
				}
				if(selected_genre=='Country'){
					selected_genre = 'Folk/Country'
				}
				if(selected_genre=='Pop'){
					selected_genre = 'Pop/R&B'
				}
				if(selected_genre=='R'){
					selected_genre = 'Pop/R&B'
				}
				if(selected_genre=='R&B'){
					selected_genre = 'Pop/R&B'
				}
				selected_genre= selected_genre.slice(0, 3);
				var index = selected_genres.indexOf(selected_genre);
				if (index > -1) {
				  selected_genres.splice(index, 1);
				}
				else{
					selected_genres.push(selected_genre)
				}

				//check if already selected
			  d3.selectAll('.dot').attr('opacity',0.03)
				for (var i = 0; i < selected_genres.length; i++) {
					d3.selectAll('.'+selected_genres[i]).attr('opacity',1)

				}
			}
				if(selected_genres.length==0){
			    d3.selectAll('.dot').attr('opacity',1)
				}
				// var dots = d3.selectAll(".dot");
				// var other_dots_index = 0;
				// if (selected_genre == "Roc") {other_dots_index = 1}
				// 	//very hacky way to undo filtering

				// if (selected_dots[0][other_dots_index].style.display == "block" &&
				// 		dots[0][other_dots_index].style.display=="none") {
				// 	//if already showing specific, show all the dots
				// 	dots.style("display", "block");
				// }
				// else {
				// 	dots.style("display", "none");
				// 	selected_dots.style("display", "block");
				// }
			}
		</script>










		<script>
			var vis3svg = d3.select("#viz3").append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom);
			var borderPath = vis3svg.append("rect")
			  .attr("x", 1)
			  .attr("y", 1)
			  .attr("height", height + margin.top + margin.bottom-10)
			  .attr("width", 560+399)
			  .style("stroke", 'black')
			  .style("fill", "none")
			  .style("stroke-width", 1);
			 var borderPath = vis3svg.append("rect")
			  .attr("x", 560)
			  .attr("y", 1)
			  .attr("height", 200)
			  .attr("width", 399)
			  .style("stroke", 'black')
			  .style("fill", "none")
			  .style("stroke-width", 1);
			vis3svg.append('text').text('The further two points are from each other,').attr('x',width-320).attr('y',height-160).attr('font-size',15).attr('font-weight','bold')
			vis3svg.append('text').text('the more distinct they are from each other!').attr('x',width-315).attr('y',height-140).attr('font-size',15).attr('font-weight','bold')
			vis3svg.append('text').text('Click on a point to view its subgenres').attr('id','disatext').attr('x',width/4-200).attr('y',height-50).attr('font-size',20).attr('font-weight','bold')

			var resetG = vis3svg.append('g')
			var genreText = resetG.append('text').attr('x',width/4).attr('y',20).attr('font-size',20).attr('font-weight','bold');
			var resetRect = resetG.append('rect').attr('x',width/2).attr('y',20).attr('rx',5).attr('ry',5).style('stroke','black').style('stroke-width',2).style('fill','#EEE').attr('width',60).attr('height',20).attr('onclick','resetDiagram()').attr('opacity',0).attr('onmouseenter',"setCursor('pointer')").attr('onmouseleave',"setCursor('default')")
			var resetText = resetG.append('text').attr('x',width/2+10).attr('y',35).text('Reset').attr('onclick','resetDiagram()').attr('opacity',0).attr('onmouseenter',"setCursor('pointer')").attr('onmouseleave',"setCursor('default')")

			var subg = vis3svg.append('g');
			subg.append('text').attr('x',width-195).attr('y',20).text('Subgenres').attr('font-size',20).attr('font-weight','bold')
			subg.append('text').attr('x',width-45).attr('y',20).text('Genres').attr('font-size',20).attr('font-weight','bold')
			subgenres_list = []
			subg_holder = {};
			sub_circle_holder = {}
			sub_holder_stable = {}
			subcircle_allholder =[]
			d3.csv("models/subgenres.csv", function(genres){
					for (var i = 0; i < genres.length; i++) {
						subg_holder[genres[i].genre] =  subg_holder[genres[i].genre]? subg_holder[genres[i].genre]+1:1;
						sub_circle_holder[genres[i].genre] =  [];
						d3.csv("models/subgenre_distances/"+genres[i].genre+'.csv', function(subgenres){
							for (var i = 0; i < subgenres.length; i++) {
								subgenres_list.push(subgenres[i])

							}
						});
					}
					for(var genre in subg_holder){
						if (subg_holder.hasOwnProperty(genre)) {
							genre=='r&b'?'randb':genre
						subg.append('text').attr('x',width-45).attr('y',10+Object.keys(subg_holder).indexOf(genre)*15+30).text(genre.charAt(0).toUpperCase() + genre.substr(1));
							for(var o = 0;o<subg_holder[genre];o++){
								tempcirc = (subg.append('circle').attr('class',genre=='r&b'?'randb':genre).
									attr('cx',(width-12*subg_holder[genre])+o*12-80).attr('cy',10+Object.keys(subg_holder).indexOf(genre)*15+30).
									attr('origx',(width-12*subg_holder[genre])+o*12-80).attr('origy',10+Object.keys(subg_holder).indexOf(genre)*15+30).
									attr('r',5).attr('fill',genreColorMapping[genre]));
								sub_circle_holder[genre].push(tempcirc);
								subcircle_allholder.push(tempcirc)
							}
						}
					}
					sub_holder_stable = sub_circle_holder;
					});
			function buildGenreDiagram(genre){
				d3.select('#disatext').transition().duration(150).attr('opacity',0)
				setCursor('default')
				genre= genre=='randb'?'r&b':genre
				genreText.text(genre.charAt(0).toUpperCase() + genre.substr(1))
					.attr("y", height-420);
				d3.csv("models/subgenre_distances/"+genre+".csv", function(d){
				links = [];
				nodes = [];
				for(sub of d){
					for(comp in sub){
						try{
							if(parseFloat(sub[comp])>=0.625){
								links.push({"source": sub.index, "target": comp, 'value':parseFloat(sub[comp]) });
							}
						}
						catch(error){}
					}

					nodes.push({"id":sub.index})
				}
				resetG.selectAll('*').attr('opacity',1)
				global_genre=genre=='r&b'?'randb':genre;
				drawGenreDiagram(links,nodes,genre)
					});
			}
			true_links= [];true_nodes = [];
			d3.csv("models/genre_distances.csv", function(d){
			links = [];
			nodes = [];
				for (var i = 0; i < d.length; i++) {
					// if(d[i].index!='folk' ){
				for (var key in d[i]) {
					if(key!='index' && key!=d[i].index){
						if(parseFloat(d[i][key])>=0.27043882555)
				    	links.push({"source": d[i].index=='r&b'?'randb':d[i].index, "target": key=='r&b'?'randb':key, 'value':parseFloat(d[i][key]) });
				    }
				}
				nodes.push({"id":d[i].index=='r&b'?'randb':d[i].index})
			// }
			}

				true_links= links;true_nodes = nodes;
				drawGenreDiagram(links,nodes)
				});

		function resetDiagram(){
			setCursor('default')
			d3.selectAll('.'+global_genre).each(function(d){
			d3.select(this).transition().duration(200)
				        .attr("cx",d3.select(this).attr('origx')).attr("cy",d3.select(this).attr('origy')).style('opacity',1);
		})
			drawGenreDiagram(true_links,true_nodes)
		}
		function drawGenreDiagram(links,nodes,genre)	 {
			genre = genre || 0;
			if(genre==0){global_genre = false;}
			vis3svg.selectAll('.links').remove();
			vis3svg.selectAll('.nodes').remove();
			vis3svg.selectAll('.labels').remove();
			var simulation = d3.forceSimulation()
			    .force("link", d3.forceLink().id(function(d) { return d.id; }))
			    .force("charge", d3.forceManyBody().strength(-1500+(66*nodes.length)))
				.force("center", d3.forceCenter(width /4, height / 2));
			var link = vis3svg.append("g")
				.attr("class", "links")
				.selectAll("line")
				.data(links)
				.enter().append("line")
				  .attr("stroke-width", function(d) { return '5px'; });
			var node = vis3svg.append("g")
				 .attr("class", "nodes")
				.selectAll("circle")
				.data(nodes)
				.enter().append("circle")
				.attr('style','stroke:#000')
				  .attr("r", 15)
				  .attr('id',function(d){return d.index})
				  .attr("fill", function(d) { return genre==0?genreColorMapping[d.id]:genreColorMapping[genre]; })
				  .attr('onclick',function(d){return genre==0?"buildGenreDiagram('"+d.id+"')":''})
				  .attr('onmouseenter',global_genre?'':"setCursor('pointer')").attr('onmouseleave',"setCursor('default')")
				  .attr('stroke','#000');
			var label = vis3svg.selectAll('.labels')
			    .data(nodes)
			    .enter()
			    .append("text")
			    .attr('class','labels')
			    .text(function (d) { return d.id=='randb'?'r&b':d.id; })
			    .style("text-anchor", "middle")
			    .style("fill", "#555")
			    .style("font-family", "Arial")
			    .style("font-size", 12);

			if(global_genre){
				d3.selectAll('.'+(genre=='r&b'?'randb':genre))
     			.transition().duration(300)
				        .attr("cx",width/4).attr('cy',height/2).style('opacity',0);
			setTimeout(function(){
				   simulation
				  .nodes(nodes)
				  .on("tick", ticked);
				simulation.force("link")
	     		.links(links);
			}, 200);
			}

     		if(!global_genre){

				simulation
			  .nodes(nodes)
			  .on("tick", ticked);
			simulation.force("link")
     		.links(links);
     		}


			if(genre==0){resetG.selectAll('*').attr('opacity',0)}


			function ticked() {
			    link
			        .attr("x1", function(d) { return d.source.x; })
			        .attr("y1", function(d) { return d.source.y; })
			        .attr("x2", function(d) { return d.target.x; })
			        .attr("y2", function(d) { return d.target.y; });

			    node
			    	.attr('id',function(d){return d.id})
			        .attr("cx", function(d) { return d.x; })
			        .attr("cy", function(d) { return d.y; })
			        .attr('stroke','#000');
			    label.attr("x", function(d){ return d.x; })
    			 .attr("y", function (d) {return d.y - 20; });
			  }
			}
		</script>


	</body>
</html>
