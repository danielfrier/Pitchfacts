<!doctype HTML>
<html>
	<head>
			<!--D3-->
			<script src="https://d3js.org/d3.v4.min.js"></script>
			<!--CSS file-->
			<link rel="stylesheet" type="text/css" href="styles.css">
			<!-- Font -->
			<link href="https://fonts.googleapis.com/css?family=PT+Serif" rel="stylesheet">
			<!-- JQuery -->
			<script src='../static/scripts/external/jquery-3.3.1.min.js'></script>

			<link href="https://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	</head>
	<body>
		<div class="main-header">
			<!-- <h1>Pitchfacts</h1> -->
			<img src="images/pitchfork3.png" />
			<div class="names">
				<a>The Latest</a>
				<a style="color: white;">Reviews</a>
				<a>Best New Music</a>
				<a>Features</a>
				<a>Artists</a>
				<a>Video</a>
			</div>
		</div>
		<div class="record-header">
			<div class="record-info">
				<h1 class="artist">
					Albert Caldarelli, Daniel Frier, <br />
					Eliot Huang & Eric Porter
				</h1>
				<h1 class="title">
					Pitchfacts
				</h1>
			</div>
			<div class="record-score">
				<div class="record">
					<img src="images/record.jpg" />
					<figcaption>INFO 4310, Spring 2018</figcaption>
				</div>
				<img class="score" src="images/score.png" />
			</div>
		</div>
		<div class="body">
			<div class="point">
				<h3>Point 1</h3>
				<p>
					Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
				</p>
				<p>
					Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
				</p>
			</div>

			<div class="viz" id="viz1">
				<h4>Could you write for Pitchfork?</h4>
				<div class="could-write-container">
					<div class="could-write-textarea">
						<textarea id="userreviewCheck" class="review_textarea"></textarea>
					</div>
					<div class="could-write-resultcontainer">
						<button onclick="checkReview();" class="review_submit">Check!</button>
						<center class="hidden" id="reviewLoading"><i class="fa fa-spinner fa-spin fa-fw fa-2x"></i></center>
						<div class="grade_container hidden" id="grade_container">
							<p id="grade_letter"></p>
							<p id="grade_percent"></p>
						</div>
					</div>
				</div>
			</div>

			<div class="viz" id="viz2">
				<h3>LSA Scatterplot</h3>
			</div>

			<div class="viz" id="viz3">
				<h3>Force Graph of Genre</h3>
			</div>

		</div>

		<!-- Jquery needed for AJAX -->
		<script
		src="https://code.jquery.com/jquery-3.3.1.js"
		integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
		crossorigin="anonymous"></script>
		<script>
		//LINE GRAPH DATA
			var setOfGenres = []; //set of genres
			var setOfYears= []; //set of years

			var reviewsOverYears = {}; //dictionary of year -> total reviews that year
			var genresOverYears = {}; //dictionary of genre -> total genre reviews over years
			var genresPercentagesOverYears = {} //dictionary of genre -> total percentage out of all reviews that year over time

			d3.csv("data/p4kreviews.csv", function(d){
				var data = d;

				//make setOfGenres and setOfYears
				for (var i=0;i<data.length;i++) {
					var genre = data[i]["genre"];
					var year = data[i]["date"].split(" ")[2];
					if (!(setOfGenres.includes(genre))) { setOfGenres.push(genre); }
					if (!(setOfYears.includes(year))) { setOfYears.push(year); }
				}
				//make genresOverYears
				for (var i=0; i<setOfGenres.length; i++) {
					var genre = setOfGenres[i]
					var genre_dict = {} //year -> number of reviews
					for (var j=0;j<data.length;j++) {
						if (genre == data[j]["genre"]) {
							var year = data[j]["date"].split(" ")[2];
							if (!(year in genre_dict)) { genre_dict[year] = 1 }
							else { genre_dict[year] = genre_dict[year] + 1 }
						}
					}
					genresOverYears[genre] = genre_dict;
				}
				//make reviewsOverYears
				for (var i=0; i<setOfYears.length; i++) {
					var year = setOfYears[i];
					var yearly_total = 0;
					for (var j=0;j<setOfGenres.length;j++) {
						var genre = setOfGenres[j];
						yearly_total = yearly_total + genresOverYears[genre][year];
					}
					reviewsOverYears[year] = yearly_total
				}
				//make genresPercentagesOverYears
				for (var i=0; i<setOfGenres.length; i++) {
					var genre = setOfGenres[i];
					var genre_percentages = {};
					for (var j=0;j<setOfYears.length;j++) {
						var year = setOfYears[j];
						var total_reviews = reviewsOverYears[year];
						var genre_reviews = genresOverYears[genre][year];
						var genre_percent = genre_reviews / total_reviews;
						genre_percentages[year] = genre_percent
					}
					genresPercentagesOverYears[genre] = genre_percentages;
				}
			});

			function checkReview(){
				var input = $("#userreviewCheck").val();

				//Running on my web server so it stays up forever
				$("#reviewLoading").removeClass("hidden");
				$.get("http://churchdeposit.com:5000/userreview",{input:input},function(data){
					console.log(data);
					$("#reviewLoading").addClass("hidden");
					if (data.success){
						var grade = data.success;
						$("#grade_container").removeClass("hidden");
						var letterGrade = (grade>0.9)?"a":
							(grade>0.8)?"b":
							(grade>0.7)?"c":
							(grade>0.6)?"d":"f";

						$("#grade_container").attr("class","grade_container grade_"+letterGrade);
						$("#grade_letter").html(letterGrade.toUpperCase());
						$("#grade_percent").html((grade*100)+"% match");
					}
				},"json");
			}
			function truncateString(str,limit){
				limit = limit||0;
				if (limit>0){max = limit;}
				if (str === null || typeof str === "undefined"){
					str = "";
				}
				var truncate = (str.length > max);

				return truncate ? str.substr(0, max-1) + '...' : str;
			}
		</script>

	</script>

	<!-- LSA SCATTER PLOT  -->

	<script src="http://d3js.org/d3.v3.min.js"></script>
	<style>
		.axis path,
		.axis line {
			fill: none;
			stroke: #000;
			shape-rendering: crispEdges;
		}
		.dot {
			stroke: #000;
		}
	</style>
	<script>
		var margin = {top: 20, right: 20, bottom: 30, left: 40},
				width = 960 - margin.left - margin.right,
				height = 500 - margin.top - margin.bottom;

		var svg2 = d3.select("#viz2").append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
			.append("g")
				.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		d3.csv("models/lsa_coords.csv", function(d){
			var data = d;

			var xData = [];
			var yData = [];
			var genreData = [];
			for (var i = 0; i < data.length; i++) {
				xData.push(parseFloat(data[i]["x"]));
				yData.push(parseFloat(data[i]["y"]));
				genreData.push(data[i]["genre"]);
			};

			var xMin = d3.extent(xData)[0];
			var xMax = d3.extent(xData)[1];
			var yMin = d3.extent(yData)[0];
			var yMax = d3.extent(yData)[1];

			var xScale = d3.scale.linear()
					.domain([xMin-1, xMax+3])
					.range([0, width]);
			var yScale = d3.scale.linear()
					.domain([yMin-0.5, yMax+0.5])
					.range([height, 0]);
			var colorScale = d3.scale.category10();

			var xAxis = d3.svg.axis()
					.scale(xScale)
					.orient("bottom");
			var yAxis = d3.svg.axis()
					.scale(yScale)
					.orient("left");

			svg2.append("g")
					.attr("class", "x axis")
					.attr("transform", "translate(0," + height + ")")
					.call(xAxis)
				.append("text")
					.attr("class", "label")
					.attr("x", width)
					.attr("y", -6)
					.style("text-anchor", "end")
					.text("LSA Dimension 1");

			svg2.append("g")
					.attr("class", "y axis")
					.call(yAxis)
				.append("text")
					.attr("class", "label")
					.attr("transform", "rotate(-90)")
					.attr("y", 6)
					.attr("dy", ".71em")
					.style("text-anchor", "end")
					.text("LSA Dimension 2")

			svg2.selectAll(".dot")
					.data(data)
				.enter().append("circle")
					.attr('class',function(d){return ('dot '+ d.genre.slice(0, 3))})
					.attr('id',function(d){return d.doc_id})
					.attr("r", 3.5)
					.attr("cx", function(d) { return xScale(d.x); })
					.attr("cy", function(d) { return yScale(d.y); })
					.style("fill", function(d) { return colorScale(d.genre); });

			var legend = svg2.selectAll(".legend")
					.data(colorScale.domain())
				.enter().append("g")
					.attr("class", "legend")
					.attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

			legend.append("rect")
					.attr("x", width - 18)
					.attr("width", 18)
					.attr("height", 18)
					.attr("onclick", "filterScatter(this)")
					.text(function(d) { return d; })
					.style("fill", colorScale);

			legend.append("text")
					.attr("x", width - 24)
					.attr("y", 9)
					.attr("dy", ".35em")
					.attr("onclick", "filterScatter(this)")
					.style("text-anchor", "end")
					.text(function(d) { return d; });
			});

			function filterScatter(x) {
				var selected_genre = x.innerHTML.slice(0, 3);
					//slice first 3 because has trouble with & and / characters

				//check if already selected
				var selected_dots = d3.selectAll("." + selected_genre);
				var dots = d3.selectAll(".dot");
				var other_dots_index = 0;
				if (selected_genre == "Roc") {other_dots_index = 1}
					//very hacky way to undo filtering

				if (selected_dots[0][other_dots_index].style.display == "block" &&
						dots[0][other_dots_index].style.display=="none") {
					//if already showing specific, show all the dots
					dots.style("display", "block");
				}
				else {
					dots.style("display", "none");
					selected_dots.style("display", "block");
				}
			}
		</script>










		<script>
			var svg = d3.select('#viz3').append('svg');


		</script>


	</body>
</html>
