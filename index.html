<!doctype HTML>
<html>
	<head>
			<!--D3-->
			<script src="https://d3js.org/d3.v4.min.js"></script>
			<!--CSS file-->
			<link rel="stylesheet" type="text/css" href="styles.css">
			<!-- Font -->
			<link href="https://fonts.googleapis.com/css?family=PT+Serif" rel="stylesheet">
			
			<link href="https://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	</head>
	<body>
		<div class="main-header">
			<!-- <h1>Pitchfacts</h1> -->
			<img src="images/pitchfork2.jpg" />
			<div class="names">
				<p>Albert Caldarelli</p>
				<p>Daniel Frier</p>
				<p>Eliot Huang</p>
				<p>Eric Porter</p>
			</div>
		</div>
		<div class="record-header">
			<div class="record-info">
				<h1 class="artist">
					INFO 4310
				</h1>
				<h1 class="title">
					Pitchfacts
				</h1>
			</div>
			<div class="record-score">
				<img class="record" src="images/record.jpg" />
				<img class="score" src="images/score.png" />
			</div>
		</div>
		<div class="body">
			<div class="point">
				<h3>Point 1</h3>
				<p>
					Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
				</p>
				<p>
					Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
				</p>
				<h4>Visualization</h4>
			</div>

			<div class="viz" id="viz1">
				<h4>Could you write for Pitchfork?</h4>
				<div class="could-write-container">
					<div class="could-write-textarea">
						<textarea id="userreviewCheck" class="review_textarea"></textarea>
					</div>
					<div class="could-write-resultcontainer">
						<button onclick="checkReview();" class="review_submit">Check!</button>
						<center class="hidden" id="reviewLoading"><i class="fa fa-spinner fa-spin fa-fw fa-2x"></i></center>
						<div class="grade_container hidden" id="grade_container">
							<p id="grade_letter"></p>
							<p id="grade_percent"></p>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Jquery needed for AJAX -->
		<script
		src="https://code.jquery.com/jquery-3.3.1.js"
		integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
		crossorigin="anonymous"></script>
		<script>
		//LINE GRAPH DATA
			var setOfGenres = []; //set of genres
			var setOfYears= []; //set of years

			var reviewsOverYears = {}; //dictionary of year -> total reviews that year
			var genresOverYears = {}; //dictionary of genre -> total genre reviews over years
			var genresPercentagesOverYears = {} //dictionary of genre -> total percentage out of all reviews that year over time

			d3.csv("data/p4kreviews.csv", function(d){
				var data = d;

				//make setOfGenres and setOfYears
				for (var i=0;i<data.length;i++) {
					var genre = data[i]["genre"];
					var year = data[i]["date"].split(" ")[2];
					if (!(setOfGenres.includes(genre))) { setOfGenres.push(genre); }
					if (!(setOfYears.includes(year))) { setOfYears.push(year); }
				}
				console.log(setOfGenres);
				console.log(setOfYears);

				//make genresOverYears
				for (var i=0; i<setOfGenres.length; i++) {
					var genre = setOfGenres[i]
					var genre_dict = {} //year -> number of reviews
					for (var j=0;j<data.length;j++) {
						if (genre == data[j]["genre"]) {
							var year = data[j]["date"].split(" ")[2];
							if (!(year in genre_dict)) { genre_dict[year] = 1 }
							else { genre_dict[year] = genre_dict[year] + 1 }
						}
					}
					genresOverYears[genre] = genre_dict;
				}
				console.log(genresOverYears);

				//make reviewsOverYears
				for (var i=0; i<setOfYears.length; i++) {
					var year = setOfYears[i];
					var yearly_total = 0;
					for (var j=0;j<setOfGenres.length;j++) {
						var genre = setOfGenres[j];
						yearly_total = yearly_total + genresOverYears[genre][year];
					}
					reviewsOverYears[year] = yearly_total
				}
				console.log(reviewsOverYears);

				//make genresPercentagesOverYears
				for (var i=0; i<setOfGenres.length; i++) {
					var genre = setOfGenres[i];
					var genre_percentages = {};
					for (var j=0;j<setOfYears.length;j++) {
						var year = setOfYears[j];
						var total_reviews = reviewsOverYears[year];
						var genre_reviews = genresOverYears[genre][year];
						var genre_percent = genre_reviews / total_reviews;
						genre_percentages[year] = genre_percent
					}
					genresPercentagesOverYears[genre] = genre_percentages;
				}
				console.log(genresPercentagesOverYears);
			});

			function checkReview(){
				var input = $("#userreviewCheck").val();

				//Running on my web server so it stays up forever
				$("#reviewLoading").removeClass("hidden");
				$.get("http://churchdeposit.com:5000/userreview",{input:input},function(data){
					console.log(data);
					$("#reviewLoading").addClass("hidden");
					if (data.success){
						var grade = data.success;
						$("#grade_container").removeClass("hidden");
						var letterGrade = (grade>0.9)?"a":
							(grade>0.8)?"b":
							(grade>0.7)?"c":
							(grade>0.6)?"d":"f";

						$("#grade_container").attr("class","grade_container grade_"+letterGrade);
						$("#grade_letter").html(letterGrade.toUpperCase());
						$("#grade_percent").html((grade*100)+"% match");
					}
				},"json");
			}
			
			function truncateString(str,limit){
				limit = limit||0;
				if (limit>0){max = limit;}
				if (str === null || typeof str === "undefined"){
					str = "";	
				}
				var truncate = (str.length > max);
				
				return truncate ? str.substr(0, max-1) + '...' : str;
			}
		</script>
	</body>
</html>
